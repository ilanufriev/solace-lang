# Виртуальная машина: Симулятор

## Концепция

Данная виртуальная машина реализует модель вычислений "комбинационная логика". Название "симулятор" было дано ей по аналогии с симуляторами языков описания аппаратуры Verilog, VHDL и библиотеки моделирования SystemC. Симулятор производит вычисления путем их разбиения на множество простейших элементов встречающихся в вычислительной технике. Значение выходов элементов зависит только от их входов (за редким исключением). Результаты вычисления одних элементов "перетекают" во входы последующих, как это происходит в комбинационных схемах. Таким образом, из простейших элементов составляется граф, способный производить более сложные вычисления. В коде он называется *NetlistGraph*.

## Типы элементов

Элементы, их которых строится *NetlistGraph*, выполняют базовые арифметические и логические операции. Некоторые из унарны, другие - бинарные, совсем немногие имеют количество портов большее, чем 3. Всего в языке SOLACE реализованы следующие базовые элементы:

- Adder - сумматор, складывает два числа;
- Multiplier - умножитель, умножает два числа;
- Divider - делитель, делит два числа;
- CmpLeq - сравнивает два числа (знак <=);
- CmpLess - сравнивает два числа (знак <);
- LBitShift - выполняет побитовый сдвиг влево;
- RBitShift - выполняет побитовый сдвиг вправо;
- LogicAnd - выполняет операцию логического И;
- LogicNot - выполняет операцию логического НЕ;
- LogicOr - выполняет операцию логического ИЛИ;
- Mux2 - мультиплексор с двумя входами;
- Register - хранит значение и передает его дальше по графу;
- Fifo - очередь, используемая для взаимодействия с другими виртуальными машинами.

Mux2, Register и Fifo не выполняют каких-либо операций, вместо этого они позволяют разбивать вычисления на логические части и управлять их потоком. Fifo же является особым элементом с особым поведением.

## FIFO (очереди)

FIFO (англ. First-In-First-Out, "первый вошел, первый вышел", очередь) - это элемент графа, позволяющий виртуальной машине связываться с внешним миром, то есть передавать данные другим ВМ и получать данные от них же. В отличие от всех остальных элементов, у очередей нет фиксированного количества портов. Вместо этого, порты создаются динамически по мере подключения к ним других узлов. Таким образом, у FIFO может не быть входов или выходов вовсе, и это нормальное поведение, поскольку данные забираются из очередей другой виртуальной машиной.

У FIFO могут быть как входы, так и выходы, в таком случае очередь имеет тип "self", и подключена сама к себе. Это позволяет сохранять часть состояния схемы между последовательными выполнениями инструкций блока "run {...}". С помощью self-очередей становится возможной реализация последовательных "многотактовых" схем.

## NetlistGraph

Главный класс всей виртуальной машины - это NetlistGraph, который уже упоминался ранее. Он является представлением вычислительного графа, с помощью которого и производятся все расчеты. Данный класс позволяет добавлять узлы в граф и соединять их между собой. Также у него есть метод evaluate(), который и выполняет вычисления, последовательно расчитывая значения выходов у каждого элемента графа.

Очередь выполнений (в коде evalQueue) определяет, в каком порядке будут проводится вычисления узлов. В промышленных симуляторах данная очередь формируется динамически, это ускоряет симуляцию, позволяя не тратить время на выполнение ненужных блоков. В данной виртуальной машине очередь выполнений статическая, вычисление узлов происходит в порядке их добавления в граф.

## Байт-код

Преимуществом данной виртуальной машины является минималистичность набора команд. В нем всего три команды:

- new - добавляет новый узел указанного типа к графу;
- con - соединяет два узла между собой;
- immcon - соединяет вход узла с константной величиной.

Это стало возможным благодаря тому, что весь вычислительный функционал вынесен в классы элементов, задача байткода - просто создать и соединить их в нужном порядке.

### Формат байт-кода

Парсингом, кодированием и декодированием байт-кода занимается глобальный объект AsmParser. Он содержит в себе методы, полезные при работе с ассемблером виртуальной машины. Декодированный ассемблер выглядит так:

```

```

